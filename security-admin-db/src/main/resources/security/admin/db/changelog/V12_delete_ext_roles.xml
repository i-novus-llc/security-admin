<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="EPMP-190-20190902-01" author="estartcev">
        <preConditions onFail="MARK_RAN">
            <not>
                <sqlCheck expectedResult="0">
                    SELECT COUNT(1) FROM sec.role r
                    WHERE r.code = 'offline_access'
                    OR r.code = 'uma_authorization'
                </sqlCheck>
            </not>
        </preConditions>
        <comment>Удаление ролей offline_access,uma_authorization</comment>
        <sql>
            DELETE FROM sec.user_role ur
            WHERE ur.role_id IN (SELECT r.id
            FROM sec.role r
            WHERE r.code = 'offline_access'
            OR r.code = 'uma_authorization');

            DELETE FROM sec.role_permission rp
            WHERE rp.role_id IN (SELECT r.id
            FROM sec.role r
            WHERE r.code = 'offline_access'
            OR r.code = 'uma_authorization');

            DELETE FROM sec.role r
            WHERE r.code = 'offline_access'
            OR r.code = 'uma_authorization';
        </sql>
    </changeSet>


</databaseChangeLog>
