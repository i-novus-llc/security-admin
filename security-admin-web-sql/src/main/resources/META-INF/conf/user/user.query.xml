<?xml version='1.0' encoding='UTF-8'?>
<query xmlns="http://n2oapp.net/framework/config/schema/query-4.0" object-id="${sec.admin.user.object.id}"
       name="Пользователи">
    <list>
        <sql>
            select :select
            from sec.user u
            where :filters
            order by :sorting, id
        </sql>
    </list>
    <count>
        <sql>
            select count(u.id)
            from sec.user u
            where :where
        </sql>
    </count>

    <fields>
        <field id="id" domain="integer">
            <select/>
            <sorting/>
            <filters>
                <eq filter-id="id"/>
            </filters>
        </field>
        <field id="guid" domain="string">
            <select/>
        </field>
        <field id="username" domain="string" name="Имя пользователя">
            <select/>
            <sorting>username :usernameDirection</sorting>
            <filters>
                <eq filter-id="username">trim(lower(username)) like '%'||trim(lower(:username))||'%'</eq>
            </filters>
        </field>
        <field id="surname" domain="string" name="Фамилия">
            <select/>
            <filters>
                <eq filter-id="surname">trim(lower(surname)) like '%'||trim(lower(:surname))||'%'</eq>
            </filters>
        </field>
        <field id="name" domain="string" name="Имя">
            <select/>
            <filters>
                <eq filter-id="name">trim(lower(name)) like '%'||trim(lower(:name))||'%'</eq>
            </filters>
        </field>
        <field id="patronymic" domain="string" name="Отчество">
            <select/>
            <filters>
                <eq filter-id="patronymic">trim(lower(patronymic)) like '%'||trim(lower(:patronymic))||'%'</eq>
            </filters>
        </field>
        <field id="email" domain="string" name="E-mail">
            <select/>
        </field>
        META-INF/conf/role/role.query.xml
        <field id="isActive" domain="boolean" name="Активность">
            <select>is_active</select>
            <sorting>is_active :isActiveDirection</sorting>
            <filters>
                <eq filter-id="isActive">is_active=:isActive</eq>
            </filters>
        </field>
        <field id="fio" domain="string" name="ФИО">
            <select mapping="['fio']">(coalesce(u.surname,'')||' '||coalesce(u.name,'')||' '||coalesce(u.patronymic,'')) as fio</select>
            <sorting>(coalesce(u.surname,'')||' '||coalesce(u.name,'')||' '||coalesce(u.patronymic,'')) :fioDirection</sorting>
            <filters>
                <eq filter-id="fio">((trim(lower(u.surname)) like '%'||trim(lower(:fio))||'%')
                    or(trim(lower(u.name)) like '%'||trim(lower(:fio))||'%' )or(trim(lower(u.patronymic)) like '%'||trim(lower(:fio))||'%') or
                    (trim(lower((coalesce(u.surname,'')||' '||coalesce(u.name,'')||' '||coalesce(u.patronymic,'')))) like '%'||trim(lower(:fio))||'%'))
                </eq>
            </filters>
        </field>
        <!--<field id="roles*.id" domain="integer[]" name="Роли">
            <select mapping="['roleIds']">
                <![CDATA[
                   (select ARRAY_AGG(r.id)
                 from sec.user_role
                ur join sec.role r on r.id=ur.role_id where ur.user_id=u.id) as roleIds
                 ]]>
            </select>
            <filters>
                <in filter-id="roleFilter*.id">
                    <![CDATA[
                        exists (select ur1.role_id
                        from sec.user_role ur1
                        where user_id = u.id and role_id in (:roleFilter*.id))
                    ]]>
                </in>
            </filters>
        </field>

        <field id="roles*.name" domain="string[]" name="Роли">
            <select mapping="['roleNames']">
                <![CDATA[
                   (select ARRAY_AGG(r.name)
                 from sec.user_role
                ur join sec.role r on r.id=ur.role_id where ur.user_id=u.id) as roleNames
                 ]]>
            </select>
        </field>-->
    </fields>
</query>
